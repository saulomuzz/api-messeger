<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Dashboard Profissional</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    
    <style>
        :root {
            /* Vari√°veis de Cor (Light Mode) */
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --bg-body: #f3f4f6;
            --bg-sidebar: #ffffff;
            --bg-card: #ffffff;
            --text-main: #1f2937;
            --text-muted: #6b7280;
            --border-color: #e5e7eb;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --radius: 10px;
            
            /* Cores Sem√¢nticas */
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
        }

        [data-theme="dark"] {
            /* Vari√°veis de Cor (Dark Mode) */
            --primary: #6366f1;
            --primary-hover: #818cf8;
            --bg-body: #111827;
            --bg-sidebar: #1f2937;
            --bg-card: #1f2937;
            --text-main: #f9fafb;
            --text-muted: #9ca3af;
            --border-color: #374151;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
        }

        /* Reset e Base */
        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-body);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            transition: background 0.3s, color 0.3s;
            overflow: hidden;
        }

        /* Sidebar Navigation */
        .sidebar {
            width: 260px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            height: 100%;
            z-index: 50;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            padding: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 10px;
        }

        .logo-icon { font-size: 24px; color: var(--primary); }
        .logo-text { font-size: 18px; font-weight: 700; color: var(--text-main); }

        .nav-links {
            flex: 1;
            overflow-y: auto;
            padding: 0 16px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            color: var(--text-muted);
            background: transparent;
            border: none;
            border-radius: var(--radius);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            width: 100%;
            text-align: left;
            transition: all 0.2s;
            text-decoration: none;
        }

        .nav-item:hover { background: rgba(79, 70, 229, 0.08); color: var(--primary); }
        .nav-item.active { background: var(--primary); color: white; box-shadow: var(--shadow); }
        .nav-item i { font-size: 18px; }

        .sidebar-footer { padding: 16px; border-top: 1px solid var(--border-color); }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        .top-bar {
            background: var(--bg-card);
            padding: 16px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
        }

        .toggle-btn { display: none; background: none; border: none; font-size: 24px; color: var(--text-main); cursor: pointer; }

        .top-actions { display: flex; align-items: center; gap: 16px; }

        .theme-toggle {
            background: none; border: none; font-size: 20px;
            color: var(--text-muted); cursor: pointer; padding: 8px;
            border-radius: 50%; transition: 0.2s;
        }
        .theme-toggle:hover { background: rgba(0,0,0,0.05); color: var(--text-main); }

        .content-scroll { padding: 32px; overflow-y: auto; flex: 1; }

        /* Components */
        .section-title { font-size: 20px; font-weight: 600; margin-bottom: 24px; color: var(--text-main); display: flex; align-items: center; gap: 8px; }
        
        /* Cards */
        .card, .stat-card, .chart-card, .metric-section, .form-card {
            background: var(--bg-card);
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
            padding: 24px;
            margin-bottom: 24px;
        }

        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 24px; }
        .stat-value { font-size: 28px; font-weight: 700; margin-bottom: 4px; }
        .stat-label { font-size: 13px; color: var(--text-muted); font-weight: 500; }

        /* Tables */
        .table-container { background: var(--bg-card); border-radius: var(--radius); border: 1px solid var(--border-color); overflow-x: auto; margin-bottom: 24px; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { background: rgba(0,0,0,0.02); text-align: left; padding: 14px; font-size: 12px; font-weight: 600; color: var(--text-muted); border-bottom: 1px solid var(--border-color); text-transform: uppercase; }
        td { padding: 14px; border-bottom: 1px solid var(--border-color); font-size: 14px; color: var(--text-main); }
        tr:last-child td { border-bottom: none; }
        
        /* Forms */
        .form-group { margin-bottom: 16px; }
        label { display: block; font-size: 13px; font-weight: 500; margin-bottom: 6px; color: var(--text-muted); }
        input, select, textarea {
            width: 100%; padding: 10px 12px; border-radius: 8px;
            border: 1px solid var(--border-color); background: var(--bg-body);
            color: var(--text-main); font-size: 14px; transition: 0.2s;
        }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }

        /* Buttons */
        .btn, .btn-primary, .btn-secondary, .btn-danger, .btn-success, .btn-filter {
            padding: 10px 18px; border-radius: 8px; font-size: 14px; font-weight: 500;
            cursor: pointer; border: none; display: inline-flex; align-items: center; gap: 6px; transition: 0.2s;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-hover); transform: translateY(-1px); }
        .btn-secondary { background: var(--bg-body); color: var(--text-main); border: 1px solid var(--border-color); }
        .btn-secondary:hover { background: rgba(0,0,0,0.05); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-success { background: var(--success); color: white; }

        /* Badges */
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; text-transform: uppercase; display: inline-block; }
        
        /* Tabs */
        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Loading */
        .loading-spinner {
            width: 30px; height: 30px; border: 3px solid rgba(79, 70, 229, 0.2);
            border-top: 3px solid var(--primary); border-radius: 50%;
            animation: spin 1s linear infinite; margin: 0 auto;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .hidden { display: none !important; }

        /* Modal */
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; background-color: rgba(0,0,0,0.6);
            align-items: center; justify-content: center; backdrop-filter: blur(2px);
        }
        .modal-content {
            background-color: var(--bg-card); margin: 5% auto; padding: 0;
            border-radius: 12px; width: 90%; max-width: 800px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            max-height: 90vh; overflow-y: auto;
            border: 1px solid var(--border-color);
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .modal-header { padding: 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { font-size: 18px; margin: 0; color: var(--text-main); }
        .modal-body { padding: 24px; }
        .modal-close { background: none; border: none; font-size: 24px; color: var(--text-muted); cursor: pointer; }

        /* Toast */
        .toast-container { position: fixed; bottom: 24px; right: 24px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
        .toast { padding: 12px 20px; border-radius: 8px; color: white; font-size: 14px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 10px; animation: slideInRight 0.3s; }
        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        .toast.warning { background: var(--warning); }
        .toast.info { background: var(--info); }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar { position: fixed; left: -260px; height: 100%; box-shadow: 0 0 20px rgba(0,0,0,0.2); }
            .sidebar.open { left: 0; }
            .toggle-btn { display: block; }
            .top-bar { padding: 16px; }
            .content-scroll { padding: 16px; }
            .stats-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <i class="ri-dashboard-3-line logo-icon"></i>
            <span class="logo-text">AdminPanel</span>
        </div>

        <nav class="nav-links">
            <button class="nav-item active" onclick="switchTab('overview', event)">
                <i class="ri-bar-chart-2-line"></i> Vis√£o Geral
            </button>
            <button class="nav-item" onclick="switchTab('lookup', event)">
                <i class="ri-search-eye-line"></i> Consultar IP
            </button>
            <button class="nav-item" onclick="switchTab('ips', event)">
                <i class="ri-forbid-line"></i> Bloqueados
            </button>
            <button class="nav-item" onclick="switchTab('whitelist', event)">
                <i class="ri-checkbox-circle-line"></i> Whitelist
            </button>
            <button class="nav-item" onclick="switchTab('yellowlist', event)">
                <i class="ri-alert-line"></i> Yellowlist
            </button>
            <button class="nav-item" onclick="switchTab('trusted', event)">
                <i class="ri-shield-check-line"></i> IPs Confi√°veis
            </button>
            <button class="nav-item" onclick="switchTab('tuya', event)">
                <i class="ri-home-wifi-line"></i> Tuya Smart
            </button>
            <button class="nav-item" onclick="switchTab('access', event)">
                <i class="ri-file-list-3-line"></i> Access Log
            </button>
            <button class="nav-item" onclick="switchTab('devices', event)">
                <i class="ri-cpu-line"></i> Dispositivos
            </button>
            <button class="nav-item" onclick="switchTab('migrations', event)">
                <i class="ri-exchange-line"></i> Migra√ß√µes
            </button>
            <button class="nav-item" onclick="switchTab('server', event)">
                <i class="ri-server-line"></i> Servidor
            </button>
            <button class="nav-item" onclick="switchTab('send', event)">
                <i class="ri-whatsapp-line"></i> Enviar Msg
            </button>
            <button class="nav-item" onclick="switchTab('comedor', event)">
                <i class="ri-goblet-line"></i> Comedor
            </button>
        </nav>

        <div class="sidebar-footer">
            <button class="nav-item" onclick="logout()" style="color: var(--danger);">
                <i class="ri-logout-box-r-line"></i> Sair
            </button>
        </div>
    </aside>

    <main class="main-content">
        <header class="top-bar">
            <div style="display: flex; align-items: center; gap: 16px;">
                <button class="toggle-btn" onclick="toggleSidebar()">
                    <i class="ri-menu-line"></i>
                </button>
                <h2 style="font-size: 18px; font-weight: 600;" id="pageTitle">Vis√£o Geral</h2>
            </div>
            
            <div class="top-actions">
                <span id="lastUpdate" style="font-size: 12px; color: var(--text-muted);"></span>
                <button class="theme-toggle" onclick="toggleTheme()" title="Alternar Tema">
                    <i class="ri-moon-line" id="themeIcon"></i>
                </button>
            </div>
        </header>

        <div class="content-scroll">

            <div id="tab-overview" class="tab-content active">
                <div class="stats-grid" id="overviewStats">
                    <div style="text-align: center; grid-column: 1/-1; padding: 40px;">
                        <div class="loading-spinner"></div>
                        <p style="margin-top: 10px; color: var(--text-muted)">Carregando dados...</p>
                    </div>
                </div>
                
                <h3 class="section-title">An√°lises</h3>
                <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));">
                    <div class="chart-card">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 16px;">
                            <strong>Mensagens (24h)</strong> <i class="ri-message-3-line text-muted"></i>
                        </div>
                        <div id="messagesChart">Carregando...</div>
                    </div>
                    <div class="chart-card">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 16px;">
                            <strong>Top Rotas</strong> <i class="ri-route-line text-muted"></i>
                        </div>
                        <div id="routesChart">Carregando...</div>
                    </div>
                    <div class="chart-card">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 16px;">
                            <strong>Top IPs</strong> <i class="ri-map-pin-line text-muted"></i>
                        </div>
                        <div id="topIPsChart">Carregando...</div>
                    </div>
                </div>
                
                <h3 class="section-title">Status do Sistema</h3>
                <div id="systemInfo" class="stats-grid"></div>
            </div>

            <div id="tab-lookup" class="tab-content">
                <div class="form-card" style="max-width: 800px; margin: 0 auto;">
                    <h3 class="section-title">Consultar IP</h3>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 20px;">
                        <input type="text" id="ipLookupInput" placeholder="Ex: 192.168.1.1" style="flex: 2;" onkeypress="if(event.key==='Enter') lookupIP()">
                        <div style="display: flex; align-items: center; gap: 8px; flex: 1;">
                            <input type="checkbox" id="checkAbuseFlag" style="width: auto;">
                            <label for="checkAbuseFlag" style="margin: 0;">AbuseIPDB</label>
                        </div>
                        <button class="btn-primary" onclick="lookupIP()" id="lookupBtn">Consultar</button>
                    </div>
                </div>
                <div class="lookup-result" id="lookupResult" style="margin-top: 24px;"></div>
            </div>

            <div id="tab-ips" class="tab-content">
                <div class="form-card">
                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        <input type="text" id="filterBlockedIP" placeholder="Filtrar IP..." style="flex: 1;" onkeypress="if(event.key==='Enter') applyFilter('blocked')">
                        <select id="filterBlockedReason" style="flex: 1;">
                            <option value="">Todos os Motivos</option>
                            <option value="AbuseIPDB">AbuseIPDB</option>
                            <option value="Manual">Manual</option>
                            <option value="Rate Limit">Rate Limit</option>
                        </select>
                        <button class="btn-primary" onclick="applyFilter('blocked')">Filtrar</button>
                        <button class="btn-secondary" onclick="clearFilter('blocked')">Limpar</button>
                    </div>
                </div>
                <div class="table-container" id="blockedTable"><div class="loading-spinner"></div></div>
            </div>

            <div id="tab-whitelist" class="tab-content">
                <div class="form-card">
                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        <input type="text" id="filterWhitelistIP" placeholder="Filtrar IP..." style="flex: 2;" onkeypress="if(event.key==='Enter') applyFilter('whitelist')">
                        <input type="number" id="filterWhitelistConfidence" placeholder="Confian√ßa M√°x %" style="flex: 1;">
                        <button class="btn-primary" onclick="applyFilter('whitelist')">Filtrar</button>
                        <button class="btn-secondary" onclick="clearFilter('whitelist')">Limpar</button>
                    </div>
                </div>
                <div class="table-container" id="whitelistTable"><div class="loading-spinner"></div></div>
            </div>

            <div id="tab-yellowlist" class="tab-content">
                <div class="form-card">
                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        <input type="text" id="filterYellowlistIP" placeholder="Filtrar IP..." style="flex: 2;" onkeypress="if(event.key==='Enter') applyFilter('yellowlist')">
                        <input type="number" id="filterYellowlistConfidence" placeholder="Confian√ßa M√≠n %" style="flex: 1;">
                        <button class="btn-primary" onclick="applyFilter('yellowlist')">Filtrar</button>
                        <button class="btn-secondary" onclick="clearFilter('yellowlist')">Limpar</button>
                    </div>
                </div>
                <div class="table-container" id="yellowlistTable"><div class="loading-spinner"></div></div>
            </div>

            <div id="tab-trusted" class="tab-content">
                <div class="stats-grid" id="trustedCategories"></div>
                
                <div class="form-card">
                    <h4 style="margin-bottom: 16px; color: var(--primary);">Adicionar Novo Range</h4>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        <input type="text" id="newRangeCIDR" placeholder="CIDR (Ex: 192.168.1.0/24)" style="flex: 2;">
                        <select id="newRangeCategory" style="flex: 1;">
                            <option value="meta">Meta/Facebook</option>
                            <option value="cloudflare">Cloudflare</option>
                            <option value="esp32">ESP32</option>
                            <option value="custom">Personalizado</option>
                        </select>
                        <input type="text" id="newRangeDescription" placeholder="Descri√ß√£o (Opcional)" style="flex: 2;">
                        <button class="btn-success" onclick="addTrustedRange()">Adicionar</button>
                    </div>
                </div>
                
                <div style="margin-bottom: 16px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <select id="filterTrustedCategory" onchange="loadTrustedRanges()" style="width: 200px;">
                        <option value="">Todas Categorias</option>
                        <option value="meta">Meta</option>
                        <option value="cloudflare">Cloudflare</option>
                        <option value="esp32">ESP32</option>
                        <option value="custom">Personalizado</option>
                    </select>
                    <select id="filterTrustedEnabled" onchange="loadTrustedRanges()" style="width: 200px;">
                        <option value="">Todos Status</option>
                        <option value="true">Habilitado</option>
                        <option value="false">Desabilitado</option>
                    </select>
                    <button class="btn-secondary" onclick="importMetaRanges()">Importar Meta</button>
                </div>
                
                <div class="table-container" id="trustedTable"><div class="loading-spinner"></div></div>
            </div>

            <div id="tab-tuya" class="tab-content">
                <div class="stats-grid" id="tuyaStats">
                    <div class="stat-card"><div class="stat-value" id="tuyaTotal">-</div><div class="stat-label">Total</div></div>
                    <div class="stat-card"><div class="stat-value" id="tuyaOnline" style="color:var(--success)">-</div><div class="stat-label">Online</div></div>
                    <div class="stat-card"><div class="stat-value" id="tuyaPoweredOn" style="color:var(--warning)">-</div><div class="stat-label">Ligados</div></div>
                    <div class="stat-card"><div class="stat-value" id="tuyaOffline" style="color:var(--danger)">-</div><div class="stat-label">Offline</div></div>
                </div>
                
                <div style="margin-bottom: 24px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn-primary" onclick="loadTuyaDevices()">Atualizar</button>
                    <button class="btn-secondary" onclick="loadTuyaEvents()">Ver Hist√≥rico</button>
                    <button class="btn-secondary" onclick="showEnergySection()">Consumo Energia</button>
                    <button class="btn-success" onclick="forceEnergyCollection()">Coletar Energia Agora</button>
                </div>
                
                <div class="table-container" id="tuyaDevicesTable"><div class="loading-spinner"></div></div>
                
                <div id="tuyaEventsSection" class="hidden" style="margin-top: 30px;">
                    <h3 class="section-title">Hist√≥rico de Eventos</h3>
                    <div class="table-container" id="tuyaEventsTable"></div>
                </div>
                
                <div id="tuyaEnergySection" class="hidden" style="margin-top: 30px;">
                    <h3 class="section-title">Consumo de Energia</h3>
                    <div class="form-card" style="margin-bottom: 20px;">
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <select id="energyDeviceSelect"></select>
                            <select id="energyPeriodSelect" style="width: 150px;">
                                <option value="24">√öltimas 24h</option>
                                <option value="48">√öltimas 48h</option>
                                <option value="168">√öltima semana</option>
                            </select>
                            <button class="btn-primary" onclick="loadEnergyChart()">Ver Gr√°fico</button>
                        </div>
                    </div>
                    <div class="stats-grid" id="energyStats"></div>
                    <div id="energyChartContainer" class="card"></div>
                </div>
            </div>

            <div id="tab-access" class="tab-content">
                <div class="stats-grid" id="accessStats"></div>
                
                <div class="form-card">
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <input type="text" id="accessFilterIP" placeholder="Filtrar IP..." style="flex: 1;">
                        <input type="text" id="accessFilterRoute" placeholder="Filtrar Rota..." style="flex: 1;">
                        <select id="accessFilterMethod" style="flex: 1;">
                            <option value="">M√©todo (Todos)</option>
                            <option value="GET">GET</option>
                            <option value="POST">POST</option>
                            <option value="PUT">PUT</option>
                            <option value="DELETE">DELETE</option>
                        </select>
                        <button class="btn-primary" onclick="loadAccessLogs()">Filtrar</button>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px; display: flex; gap: 10px;">
                    <button class="btn-secondary" onclick="showAccessView('logs')">Logs</button>
                    <button class="btn-secondary" onclick="showAccessView('routes')">Top Rotas</button>
                    <button class="btn-secondary" onclick="showAccessView('ips')">Top IPs</button>
                </div>
                
                <div id="accessLogsView" class="table-container"></div>
                <div id="accessRoutesView" class="table-container hidden"></div>
                <div id="accessIPsView" class="table-container hidden"></div>
            </div>

            <div id="tab-devices" class="tab-content">
                <div class="table-container" id="devicesTable"><div class="loading-spinner"></div></div>
            </div>

            <div id="tab-migrations" class="tab-content">
                <div class="form-card">
                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        <input type="text" id="filterMigrationsIP" placeholder="Filtrar IP..." style="flex: 2;" onkeypress="if(event.key==='Enter') applyFilter('migrations')">
                        <select id="filterMigrationsToList" style="flex: 1;">
                            <option value="">Destino (Todas)</option>
                            <option value="whitelist">Whitelist</option>
                            <option value="yellowlist">Yellowlist</option>
                            <option value="blacklist">Blacklist</option>
                        </select>
                        <button class="btn-primary" onclick="applyFilter('migrations')">Filtrar</button>
                        <button class="btn-secondary" onclick="clearFilter('migrations')">Limpar</button>
                    </div>
                </div>
                <div class="table-container" id="migrationsTable"><div class="loading-spinner"></div></div>
            </div>

            <div id="tab-server" class="tab-content">
                <div style="display: grid; gap: 20px;">
                    <div class="metric-section">
                        <h3><i class="ri-cpu-line"></i> Processamento (CPU)</h3>
                        <div class="stats-grid" style="margin-top: 16px;">
                            <div class="stat-card">
                                <div class="stat-label">1 min</div>
                                <div class="stat-value" id="cpu1min">-</div>
                                <div style="height:6px; background:#eee; border-radius:3px; overflow:hidden;"><div id="cpu1minBar" style="height:100%; width:0%; background:var(--primary); transition:width 0.3s;"></div></div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">5 min</div>
                                <div class="stat-value" id="cpu5min">-</div>
                                <div style="height:6px; background:#eee; border-radius:3px; overflow:hidden;"><div id="cpu5minBar" style="height:100%; width:0%; background:var(--primary); transition:width 0.3s;"></div></div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">15 min</div>
                                <div class="stat-value" id="cpu15min">-</div>
                                <div style="height:6px; background:#eee; border-radius:3px; overflow:hidden;"><div id="cpu15minBar" style="height:100%; width:0%; background:var(--primary); transition:width 0.3s;"></div></div>
                            </div>
                        </div>
                    </div>

                    <div class="stats-grid">
                        <div class="metric-section">
                            <h3><i class="ri-database-2-line"></i> Mem√≥ria</h3>
                            <div style="margin-top: 16px;">
                                <div style="display:flex; justify-content:space-between; margin-bottom:8px;"><span>Em Uso</span><strong id="memUsed">-</strong></div>
                                <div style="height:8px; background:#eee; border-radius:4px; overflow:hidden; margin-bottom:12px;"><div id="memUsedBar" style="height:100%; width:0%; background:var(--warning); transition:width 0.3s;"></div></div>
                                <div style="display:flex; justify-content:space-between; font-size:13px; color:var(--text-muted);">
                                    <span>Total: <span id="memTotal">-</span></span>
                                    <span>Livre: <span id="memFree">-</span></span>
                                </div>
                            </div>
                        </div>
                        <div class="metric-section">
                            <h3><i class="ri-hard-drive-2-line"></i> Disco</h3>
                            <div style="margin-top: 16px;">
                                <div style="display:flex; justify-content:space-between; margin-bottom:8px;"><span>Em Uso</span><strong id="diskUsed">-</strong></div>
                                <div style="height:8px; background:#eee; border-radius:4px; overflow:hidden; margin-bottom:12px;"><div id="diskUsedBar" style="height:100%; width:0%; background:var(--success); transition:width 0.3s;"></div></div>
                                <div style="display:flex; justify-content:space-between; font-size:13px; color:var(--text-muted);">
                                    <span>Total: <span id="diskTotal">-</span></span>
                                    <span>Livre: <span id="diskFree">-</span></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="metric-section">
                        <h3>API AbuseIPDB</h3>
                        <div id="abuseipdbStats" class="stats-grid" style="margin-top: 16px;"></div>
                    </div>
                    
                    <div class="metric-section">
                        <h3>Info do Sistema</h3>
                        <div class="stats-grid" style="margin-top: 16px; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));">
                            <div class="card" style="padding: 16px;"><span style="color:var(--text-muted); font-size:12px;">OS</span><br><strong id="sysOS">-</strong></div>
                            <div class="card" style="padding: 16px;"><span style="color:var(--text-muted); font-size:12px;">Uptime</span><br><strong id="sysUptime">-</strong></div>
                            <div class="card" style="padding: 16px;"><span style="color:var(--text-muted); font-size:12px;">Hostname</span><br><strong id="sysHostname">-</strong></div>
                            <div class="card" style="padding: 16px;"><span style="color:var(--text-muted); font-size:12px;">Plataforma</span><br><strong id="sysPlatform">-</strong></div>
                        </div>
                        
                        <div style="margin-top: 24px;">
                            <h4 style="margin-bottom: 12px;">Dispositivos Confi√°veis (Painel)</h4>
                            <div style="display: flex; gap: 10px; margin-bottom: 16px;">
                                <button class="btn-primary" onclick="loadTrustedDevices()">Atualizar</button>
                                <button class="btn-danger" onclick="revokeAllDevices()">Revogar Todos</button>
                            </div>
                            <div class="table-container" id="trustedDevicesTable"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-send" class="tab-content">
                <div class="form-card">
                    <h3 class="section-title">Enviar Mensagem WhatsApp</h3>
                    
                    <div style="display: flex; gap: 10px; margin-bottom: 24px;">
                        <button class="btn-primary" onclick="switchSendType('template')" id="btnTypeTemplate">Template (C√≥digo)</button>
                        <button class="btn-secondary" onclick="switchSendType('text')" id="btnTypeText">Texto Livre</button>
                    </div>

                    <div id="sendFormTemplate">
                        <div class="form-group" style="background: rgba(79, 70, 229, 0.05); padding: 16px; border-radius: 8px; border: 1px solid rgba(79, 70, 229, 0.1);">
                            <p style="font-size: 13px; color: var(--text-muted);">Envia c√≥digo usando template 'status' na vari√°vel {{1}}.</p>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div class="form-group">
                                <label>Telefone (com DDD)</label>
                                <input type="text" id="templatePhone" placeholder="Ex: 5511999999999">
                            </div>
                            <div class="form-group">
                                <label>C√≥digo</label>
                                <input type="text" id="templateCode" placeholder="Ex: 123456" onkeypress="if(event.key==='Enter') sendTemplateMessage()">
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                            <div class="form-group">
                                <label>Template</label>
                                <input type="text" id="templateName" value="status">
                            </div>
                            <div class="form-group">
                                <label>Idioma</label>
                                <select id="templateLang">
                                    <option value="pt_BR">Portugu√™s (BR)</option>
                                    <option value="en_US">Ingl√™s (US)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Local Param</label>
                                <select id="templateParamLocation">
                                    <option value="none">Nenhum</option>
                                    <option value="header">Header</option>
                                    <option value="body">Body</option>
                                </select>
                            </div>
                        </div>
                        <button class="btn-success" style="width: 100%; justify-content: center; margin-top: 10px;" onclick="sendTemplateMessage()">üì§ Enviar Template</button>
                    </div>

                    <div id="sendFormText" class="hidden">
                        <div class="form-group">
                            <label>Telefone</label>
                            <input type="text" id="textPhone" placeholder="Ex: 5511999999999">
                        </div>
                        <div class="form-group">
                            <label>Assunto (Opcional)</label>
                            <input type="text" id="textSubject" placeholder="Ex: Aviso">
                        </div>
                        <div class="form-group">
                            <label>Mensagem</label>
                            <textarea id="textMessage" rows="4" placeholder="Digite sua mensagem..."></textarea>
                        </div>
                        <button class="btn-success" style="width: 100%; justify-content: center;" onclick="sendTextMessageForm()">üì§ Enviar Texto</button>
                    </div>
                    
                    <div id="sendResult" style="margin-top: 20px;"></div>
                    
                    <div style="margin-top: 30px;">
                        <h4>Hist√≥rico Recente</h4>
                        <div id="sendHistory" style="margin-top: 10px; border: 1px solid var(--border-color); border-radius: 8px; padding: 10px; max-height: 200px; overflow-y: auto;">
                            <p style="text-align: center; color: var(--text-muted); padding: 20px;">Nenhum envio nesta sess√£o.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-comedor" class="tab-content">
                <div class="form-card">
                    <h3 class="section-title">üîë Configura√ß√£o de Token</h3>
                    <div style="display: flex; gap: 12px; align-items: flex-end; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 250px;">
                            <label>Token de Autentica√ß√£o</label>
                            <input type="password" id="comedorToken" placeholder="Digite o token...">
                            <small id="tokenStatus" style="display: block; margin-top: 5px; font-weight: 500;">Verificando...</small>
                        </div>
                        <button class="btn-primary" onclick="saveComedorToken()">üíæ Salvar Token</button>
                    </div>
                </div>
                
                <div class="form-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 class="section-title" style="margin-bottom: 0;">üì± Dispositivos Conectados</h3>
                        <button class="btn-secondary" onclick="loadComedorDevices()"><i class="ri-refresh-line"></i> Atualizar</button>
                    </div>
                    <div class="table-container" id="comedorDevicesTable"><div class="loading-spinner"></div></div>
                </div>
            </div>

        </div>
    </main>

    <div class="toast-container" id="toastContainer"></div>

    <div id="tuyaDeviceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Detalhes do Dispositivo</h2>
                <button class="modal-close" onclick="closeTuyaDeviceModal()">&times;</button>
            </div>
            <div class="modal-body" id="tuyaDeviceModalBody"></div>
        </div>
    </div>
    
    <div id="comedorDeviceModal" class="modal">
         <div class="modal-content">
            <div class="modal-header">
                <h2>Configura√ß√µes do Dispositivo</h2>
                <button class="modal-close" onclick="closeComedorDeviceModal()">&times;</button>
            </div>
            <div class="modal-body" id="comedorDeviceModalBody">
                <div class="loading-spinner"></div>
            </div>
        </div>
    </div>

    <script src="/admin/static/js/dashboard.js"></script>
    <script>
        // --- UI UTILS ---
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        function toggleTheme() {
            const html = document.documentElement;
            const current = html.getAttribute('data-theme');
            const newTheme = current === 'light' ? 'dark' : 'light';
            html.setAttribute('data-theme', newTheme);
            document.getElementById('themeIcon').className = newTheme === 'light' ? 'ri-moon-line' : 'ri-sun-line';
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            let icon = 'ri-information-line';
            if (type === 'success') icon = 'ri-checkbox-circle-line';
            if (type === 'error') icon = 'ri-error-warning-line';
            if (type === 'warning') icon = 'ri-alert-line';

            toast.innerHTML = `<i class="${icon}"></i> <span>${message}</span>`;
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideInRight 0.3s reverse';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        // --- NAVIGATION LOGIC ---
        // Hook into existing switchTab or create new one
        const originalSwitchTab = window.switchTab;
        window.switchTab = function(tabName, event) {
            // UI Update
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if(event && event.currentTarget) {
                event.currentTarget.classList.add('active');
                document.getElementById('pageTitle').innerText = event.currentTarget.innerText.trim();
            }
            
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            const target = document.getElementById('tab-' + tabName);
            if(target) target.classList.add('active');
            
            // Close mobile sidebar
            if(window.innerWidth < 768) document.getElementById('sidebar').classList.remove('open');

            // Call original loader
            if (typeof window.loadTabData === 'function') {
                window.loadTabData(tabName);
            } else if (originalSwitchTab) {
                originalSwitchTab(tabName, event);
            }
            
            // Specific Loaders
            if (tabName === 'comedor') loadComedorTab();
        };

        // --- COMEDOR LOGIC (INTEGRATED) ---
        let currentEditingDevice = null;

        async function loadComedorToken() {
           try {
               const response = await fetch('/admin/api/comedor/config/token');
               const data = await response.json();
               const ts = document.getElementById('tokenStatus');
               const ti = document.getElementById('comedorToken');
               
               if (data.success) {
                   if (data.config.hasToken) {
                       ts.innerHTML = '<span style="color: var(--success);">‚úÖ Token configurado</span>';
                       ti.placeholder = 'Token oculto (digite para alterar)';
                   } else {
                       ts.innerHTML = '<span style="color: var(--danger);">‚ùå Pendente</span>';
                       ti.placeholder = 'Digite o token...';
                   }
               }
           } catch (error) { console.error(error); }
        }
       
       async function saveComedorToken() {
           const token = document.getElementById('comedorToken').value.trim();
           if (!token) return showToast('Digite um token', 'error');
           
           try {
               const res = await fetch('/admin/api/comedor/config/token', {
                   method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ token })
               });
               const data = await res.json();
               if (data.success) {
                   showToast('Token salvo!', 'success');
                   document.getElementById('comedorToken').value = '';
                   loadComedorToken();
               } else {
                   showToast(data.error || 'Erro', 'error');
               }
           } catch (e) { showToast('Erro de conex√£o', 'error'); }
       }
       
       async function loadComedorDevices() {
           const container = document.getElementById('comedorDevicesTable');
           container.innerHTML = '<div class="loading-spinner"></div>';
           
           try {
               const res = await fetch('/admin/api/comedor/devices');
               const data = await res.json();
               
               if (data.success && data.devices.length > 0) {
                   let html = '<table><thead><tr><th>MAC / ID</th><th>IP</th><th>Status</th><th>Adotado</th><th>√öltima Ativ.</th><th>A√ß√µes</th></tr></thead><tbody>';
                   
                   data.devices.forEach(d => {
                       const status = d.isOnline ? '<span class="badge" style="background: var(--success); color: white">Online</span>' : '<span class="badge" style="background: var(--danger); color: white">Offline</span>';
                       const adopted = d.adopted ? '<span class="badge" style="background: var(--info); color: white">Sim</span>' : '<span class="badge" style="background: var(--warning); color: white">N√£o</span>';
                       
                       const btnAdopt = d.adopted 
                           ? `<button class="btn-danger" style="padding: 4px 8px; font-size: 11px;" onclick="unadoptDevice('${d.ip}', '${d.deviceId||''}')">Remover</button>`
                           : `<button class="btn-success" style="padding: 4px 8px; font-size: 11px;" onclick="adoptDevice('${d.ip}', '${d.deviceId||''}')">Adotar</button>`;

                       html += `<tr>
                           <td><code style="background: rgba(0,0,0,0.05); padding: 2px 4px; border-radius: 4px;">${d.deviceId || 'N/A'}</code></td>
                           <td><strong>${d.ip}</strong></td>
                           <td>${status}</td>
                           <td>${adopted}</td>
                           <td>${d.lastSeenText || '-'}</td>
                           <td style="display:flex; gap: 4px;">
                               ${btnAdopt}
                               <button class="btn-secondary" style="padding: 4px 8px; font-size: 11px;" onclick="openDeviceConfigModal('${d.ip}', '${d.deviceId||''}')">‚öôÔ∏è Config</button>
                               <button class="btn-secondary" style="padding: 4px 8px; font-size: 11px;" onclick="viewDeviceDetails('${d.ip}', '${d.deviceId||''}')">‚ÑπÔ∏è Detalhes</button>
                           </td>
                       </tr>`;
                   });
                   html += '</tbody></table>';
                   container.innerHTML = html;
               } else {
                   container.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-muted);">Nenhum dispositivo encontrado.</div>';
               }
           } catch (e) { container.innerHTML = 'Erro ao carregar.'; }
       }

       async function adoptDevice(ip, id) {
           if(!confirm('Deseja adotar este dispositivo?')) return;
           try {
               const body = id ? { ip, deviceId: id } : { ip };
               const res = await fetch('/admin/api/comedor/device/adopt', {
                   method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body)
               });
               const data = await res.json();
               if(data.success) {
                   showToast('Dispositivo adotado!', 'success');
                   setTimeout(loadComedorDevices, 500);
               } else { showToast(data.error, 'error'); }
           } catch(e) { showToast('Erro ao adotar', 'error'); }
       }

       async function unadoptDevice(ip, id) {
           if(!confirm('Remover ado√ß√£o? O dispositivo precisar√° do token novamente.')) return;
           try {
               const body = id ? { ip, deviceId: id } : { ip };
               const res = await fetch('/admin/api/comedor/device/unadopt', {
                   method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body)
               });
               const data = await res.json();
               if(data.success) {
                   showToast('Ado√ß√£o removida!', 'success');
                   setTimeout(loadComedorDevices, 500);
               } else { showToast(data.error, 'error'); }
           } catch(e) { showToast('Erro ao remover', 'error'); }
       }

       async function viewDeviceDetails(ip, id) {
           try {
               const q = id ? `ip=${ip}&deviceId=${id}` : `ip=${ip}`;
               const res = await fetch(`/admin/api/comedor/device/status?${q}`);
               const data = await res.json();
               if(data.success) {
                   const d = data.device;
                   let msg = `IP: ${d.ip}\nID: ${d.deviceId}\nStatus: ${d.isOnline?'Online':'Offline'}\n`;
                   if(d.config) {
                       msg += `\nConfig:\nStepper Speed: ${d.config.stepperSpeed || 'N/A'}\nScale Factor: ${d.config.scaleFactor || 'N/A'}`;
                   }
                   alert(msg);
               }
           } catch(e) { console.error(e); }
       }

       // --- COMPLEX CONFIG MODAL LOGIC (REFATORED & COPIED) ---
       async function openDeviceConfigModal(deviceIp, deviceId) {
            currentEditingDevice = { ip: deviceIp, deviceId: deviceId || null };
            const modal = document.getElementById('comedorDeviceModal');
            const modalBody = document.getElementById('comedorDeviceModalBody');
            
            modalBody.innerHTML = '<div class="loading-spinner"></div><p style="text-align:center">Carregando...</p>';
            modal.style.display = 'flex';
            
            try {
                const queryParams = deviceId ? `ip=${deviceIp}&deviceId=${deviceId}` : `ip=${deviceIp}`;
                const response = await fetch(`/admin/api/comedor/device/status?${queryParams}`);
                const data = await response.json();
                
                if (data.success) {
                    const device = data.device;
                    const config = device.config || {};
                    const schedules = device.schedules || config.schedules || [];

                    let html = '<form id="deviceConfigForm" onsubmit="return false;">';
                    
                    // --- Se√ß√£o Stepper ---
                    html += '<div class="form-card" style="border:1px solid var(--border-color); box-shadow:none; background:rgba(0,0,0,0.02);">';
                    html += '<h4 style="margin-bottom:15px; color:var(--primary);">üî© Stepper Motor</h4>';
                    html += '<div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">';
                    
                    html += `<div class="form-group"><label>Sentido</label>
                            <select name="stepperDirection">
                                <option value="false" ${config.stepperDirection === false ? 'selected' : ''}>Anti-hor√°rio</option>
                                <option value="true" ${config.stepperDirection === true ? 'selected' : ''}>Hor√°rio</option>
                            </select></div>`;
                    
                    html += `<div class="form-group"><label>Velocidade (Œºs)</label>
                            <input type="number" name="stepperSpeed" value="${config.stepperSpeed || ''}" placeholder="Ex: 500"></div>`;
                    
                    html += `<div class="form-group"><label>Passos Forward</label>
                            <input type="number" name="stepperStepsForward" value="${config.stepperStepsForward || ''}" placeholder="Ex: 100"></div>`;
                            
                    html += `<div class="form-group"><label>Passos Backoff</label>
                            <input type="number" name="stepperBackoffSteps" value="${config.stepperBackoffSteps || ''}" placeholder="Ex: 5"></div>`;
                    html += '</div></div>';

                    // --- Se√ß√£o Servo ---
                    html += '<div class="form-card" style="border:1px solid var(--border-color); box-shadow:none; background:rgba(0,0,0,0.02);">';
                    html += '<h4 style="margin-bottom:15px; color:var(--primary);">‚öôÔ∏è Servo Motor</h4>';
                    html += '<div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:15px;">';
                    
                    html += `<div class="form-group"><label>Tempo Pote A (ms)</label><input type="number" name="servoTimeA" value="${config.servoTimeA || ''}"></div>`;
                    html += `<div class="form-group"><label>Tempo Pote B (ms)</label><input type="number" name="servoTimeB" value="${config.servoTimeB || ''}"></div>`;
                    html += `<div class="form-group"><label>Vel. Padr√£o</label><input type="number" name="servoSpeed" value="${config.servoSpeed || ''}"></div>`;
                    html += `<div class="form-group"><label>Vel. A</label><input type="number" name="servoSpeedA" value="${config.servoSpeedA || ''}"></div>`;
                    html += `<div class="form-group"><label>Vel. B</label><input type="number" name="servoSpeedB" value="${config.servoSpeedB || ''}"></div>`;
                    html += `<div class="form-group"><label>Usar Sensor HOME</label>
                            <select name="servoUseHome">
                                <option value="false" ${config.servoUseHome === false ? 'selected' : ''}>N√£o</option>
                                <option value="true" ${config.servoUseHome === true ? 'selected' : ''}>Sim</option>
                            </select></div>`;
                    html += '</div></div>';

                    // --- Se√ß√£o Balan√ßa ---
                    html += '<div class="form-card" style="border:1px solid var(--border-color); box-shadow:none; background:rgba(0,0,0,0.02);">';
                    html += '<h4 style="margin-bottom:15px; color:var(--primary);">‚öñÔ∏è Balan√ßa (use v√≠rgula)</h4>';
                    html += '<div style="display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap:15px;">';
                    html += `<div class="form-group"><label>Offset</label><input type="text" name="scaleOffset" value="${String(config.scaleOffset||'0').replace('.',',')}"></div>`;
                    html += `<div class="form-group"><label>Fator Calibra√ß√£o</label><input type="text" name="scaleFactor" value="${String(config.scaleFactor||'').replace('.',',')}"></div>`;
                    html += `<div class="form-group"><label>Toler√¢ncia (g)</label><input type="text" name="weightTolerance" value="${String(config.weightTolerance||'').replace('.',',')}"></div>`;
                    html += `<div class="form-group"><label>Tol. Zero (g)</label><input type="text" name="scaleZeroTolerance" value="${String(config.scaleZeroTolerance||'').replace('.',',')}"></div>`;
                    html += '</div></div>';

                    // --- Se√ß√£o Alimenta√ß√£o ---
                    html += '<div class="form-card" style="border:1px solid var(--border-color); box-shadow:none; background:rgba(0,0,0,0.02);">';
                    html += '<h4 style="margin-bottom:15px; color:var(--primary);">üçΩÔ∏è Alimenta√ß√£o</h4>';
                    html += '<div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">';
                    html += `<div class="form-group"><label>Qtd Padr√£o A (g)</label><input type="text" name="defaultFeedAmountA" value="${String(config.defaultFeedAmountA||'').replace('.',',')}"></div>`;
                    html += `<div class="form-group"><label>Qtd Padr√£o B (g)</label><input type="text" name="defaultFeedAmountB" value="${String(config.defaultFeedAmountB||'').replace('.',',')}"></div>`;
                    html += `<div class="form-group"><label>Intervalo Fallback (s)</label><input type="number" name="fallbackInterval" value="${config.fallbackInterval || ''}"></div>`;
                    html += '</div></div>';

                    // --- Se√ß√£o Reservat√≥rio ---
                    html += '<div class="form-card" style="border:1px solid var(--border-color); box-shadow:none; background:rgba(0,0,0,0.02);">';
                    html += '<h4 style="margin-bottom:15px; color:var(--primary);">üíß Reservat√≥rio</h4>';
                    html += '<div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">';
                    html += `<div class="form-group"><label>Res. Vazio (cm)</label><input type="text" name="reservoirEmptyCm" value="${String(config.reservoirEmptyCm||'').replace('.',',')}"></div>`;
                    html += `<div class="form-group"><label>Res. Cheio (cm)</label><input type="text" name="reservoirFullCm" value="${String(config.reservoirFullCm||'').replace('.',',')}"></div>`;
                    html += '</div></div>';

                    // --- Se√ß√£o Debug ---
                    html += '<div class="form-card" style="border:1px solid var(--border-color); box-shadow:none; background:rgba(0,0,0,0.02);">';
                    html += '<h4 style="margin-bottom:15px; color:var(--primary);">üêõ Debug</h4>';
                    html += '<div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">';
                    html += `<div class="form-group"><label>Debug Mode</label><select name="debugEnabled"><option value="false" ${!config.debugEnabled?'selected':''}>Off</option><option value="true" ${config.debugEnabled?'selected':''}>On</option></select></div>`;
                    html += `<div class="form-group"><label>Debug Sensor N√≠vel</label><select name="debugLevelSensor"><option value="false" ${!config.debugLevelSensor?'selected':''}>Off</option><option value="true" ${config.debugLevelSensor?'selected':''}>On</option></select></div>`;
                    html += '</div></div>';

                    // --- Se√ß√£o Animais e Notifica√ß√µes ---
                    html += '<div class="form-card" style="border:1px solid var(--border-color); box-shadow:none; background:rgba(0,0,0,0.02);">';
                    html += '<h4 style="margin-bottom:15px; color:var(--primary);">üêæ Animais e Notifica√ß√µes</h4>';
                    html += '<div style="display:grid; grid-template-columns: 1fr; gap:15px;">';
                    html += `<div class="form-group"><label>Tipo de Animal</label><input type="text" name="animalType" value="${config.animalType||''}" placeholder="Ex: cachorros" maxlength="31"></div>`;
                    html += `<div class="form-group"><label>Nome Animal A</label><input type="text" name="animalAName" value="${config.animalAName||''}" placeholder="Ex: Nat" maxlength="31"></div>`;
                    html += `<div class="form-group"><label>Nome Animal B</label><input type="text" name="animalBName" value="${config.animalBName||''}" placeholder="Ex: Bolota" maxlength="31"></div>`;
                    html += `<div class="form-group"><label>URL Notifica√ß√£o API</label><input type="text" name="apiNotificationUrl" value="${config.apiNotificationUrl||''}" placeholder="Ex: api.example.com" maxlength="127"></div>`;
                    html += `<div class="form-group"><label>Usar SSL (HTTPS)</label><select name="apiNotificationUseSSL"><option value="false" ${!config.apiNotificationUseSSL?'selected':''}>N√£o</option><option value="true" ${config.apiNotificationUseSSL?'selected':''}>Sim</option></select></div>`;
                    html += '</div></div>';

                    // --- Hor√°rios ---
                    html += '<div class="form-card" style="border:1px solid var(--border-color); box-shadow:none; background:rgba(0,0,0,0.02);">';
                    html += '<h4 style="margin-bottom:15px; color:var(--primary);">‚è∞ Hor√°rios</h4>';
                    html += '<div class="table-container"><table><thead><tr><th>#</th><th>Hora</th><th>Min</th><th>Qtd A</th><th>Qtd B</th><th>Ativo</th></tr></thead><tbody>';
                    
                    for (let i = 0; i < 10; i++) {
                        const s = schedules[i] || { hour: 0, minute: 0, amountA: 0, amountB: 0, enabled: false };
                        html += `<tr>
                            <td>${i+1}</td>
                            <td><input type="number" name="schedule${i}_hour" value="${s.hour}" style="width:60px"></td>
                            <td><input type="number" name="schedule${i}_minute" value="${s.minute}" style="width:60px"></td>
                            <td><input type="text" name="schedule${i}_amountA" value="${String(s.amountA).replace('.',',')}" style="width:70px"></td>
                            <td><input type="text" name="schedule${i}_amountB" value="${String(s.amountB).replace('.',',')}" style="width:70px"></td>
                            <td><select name="schedule${i}_enabled" style="width:90px"><option value="false" ${!s.enabled?'selected':''}>N√£o</option><option value="true" ${s.enabled?'selected':''}>Sim</option></select></td>
                        </tr>`;
                    }
                    html += '</tbody></table></div></div>';

                    // Bot√µes
                    html += '<div style="display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;">';
                    html += '<button type="button" class="btn-success" onclick="fetchDeviceConfigFromESP()" style="flex:1">‚¨áÔ∏è Ler do ESP</button>';
                    html += '<button type="button" class="btn-primary" onclick="saveDeviceConfig(event)" style="flex:1">üíæ Salvar (API)</button>';
                    html += '<button type="button" class="btn-info" onclick="sendConfigToESP()" style="flex:1; background: var(--info); color:white;">‚¨ÜÔ∏è Enviar p/ ESP</button>';
                    html += '</div>';

                    html += '</form>';
                    modalBody.innerHTML = html;
                }
            } catch (e) {
                console.error(e);
                modalBody.innerHTML = '<p style="color:var(--danger)">Erro ao carregar configura√ß√µes.</p>';
            }
       }

       async function saveDeviceConfig(event) {
            if(event) event.preventDefault();
            if (!currentEditingDevice) return;
            const form = document.getElementById('deviceConfigForm');
            const fd = new FormData(form);
            
            // Helper para parsear floats com virgula
            const pFloat = (name) => {
                const val = fd.get(name);
                return val ? parseFloat(val.replace(',', '.')) : undefined;
            };
            const pInt = (name) => {
                const val = fd.get(name);
                return val ? parseInt(val) : undefined;
            };
            const pBool = (name) => fd.get(name) === 'true';

            const config = {
                stepperDirection: pBool('stepperDirection'),
                stepperSpeed: pInt('stepperSpeed'),
                stepperStepsForward: pInt('stepperStepsForward'),
                stepperBackoffSteps: pInt('stepperBackoffSteps'),
                servoTimeA: pInt('servoTimeA'),
                servoTimeB: pInt('servoTimeB'),
                servoSpeed: pInt('servoSpeed'),
                servoSpeedA: pInt('servoSpeedA'),
                servoSpeedB: pInt('servoSpeedB'),
                servoUseHome: pBool('servoUseHome'),
                scaleOffset: pFloat('scaleOffset'),
                scaleFactor: pFloat('scaleFactor'),
                weightTolerance: pFloat('weightTolerance'),
                scaleZeroTolerance: pFloat('scaleZeroTolerance'),
                defaultFeedAmountA: pFloat('defaultFeedAmountA'),
                defaultFeedAmountB: pFloat('defaultFeedAmountB'),
                fallbackInterval: pInt('fallbackInterval'),
                reservoirEmptyCm: pFloat('reservoirEmptyCm'),
                reservoirFullCm: pFloat('reservoirFullCm'),
                debugEnabled: pBool('debugEnabled'),
                debugLevelSensor: pBool('debugLevelSensor'),
                animalType: fd.get('animalType') || undefined,
                animalAName: fd.get('animalAName') || undefined,
                animalBName: fd.get('animalBName') || undefined,
                apiNotificationUrl: fd.get('apiNotificationUrl') || undefined,
                apiNotificationUseSSL: pBool('apiNotificationUseSSL')
            };

            const schedules = [];
            for (let i = 0; i < 10; i++) {
                schedules.push({
                    hour: parseInt(fd.get(`schedule${i}_hour`)) || 0,
                    minute: parseInt(fd.get(`schedule${i}_minute`)) || 0,
                    amountA: parseFloat(fd.get(`schedule${i}_amountA`).replace(',', '.')) || 0,
                    amountB: parseFloat(fd.get(`schedule${i}_amountB`).replace(',', '.')) || 0,
                    enabled: fd.get(`schedule${i}_enabled`) === 'true'
                });
            }
            config.schedules = schedules;

            // Limpa undefined
            Object.keys(config).forEach(key => config[key] === undefined && delete config[key]);

            try {
                const res = await fetch('/admin/api/comedor/device/config', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ ip: currentEditingDevice.ip, deviceId: currentEditingDevice.deviceId, config, sendToDevice: false })
                });
                const data = await res.json();
                if(data.success) {
                    showToast('Salvo na API com sucesso!', 'success');
                } else {
                    showToast('Erro ao salvar: ' + data.error, 'error');
                }
            } catch(e) { showToast('Erro de requisi√ß√£o', 'error'); }
       }

       async function sendConfigToESP() {
           // Basicamente salva primeiro, depois manda flag true
           await saveDeviceConfig(null); // Salva na API antes
           
           try {
               // Re-ler config do form ou mandar comando de sync
               // Aqui vamos simplificar mandando o comando de sync usando o endpoint
               // Mas precisamos enviar o config de novo com sendToDevice: true
               // Para evitar duplicidade de c√≥digo, idealmente refatorar√≠amos, mas vamos fazer o fetch direto aqui com os dados salvos no form (reusando a l√≥gica acima seria melhor, mas vou copiar a estrutura do save para garantir envio)
               
               const form = document.getElementById('deviceConfigForm');
               // ... (mesma l√≥gica de extra√ß√£o do saveDeviceConfig) ...
               // Para ser pr√°tico e n√£o repetir 50 linhas, vamos assumir que o usu√°rio clicou em salvar antes ou que chamamos saveDeviceConfig
               // Vamos fazer um fetch espec√≠fico assumindo que a API pega do banco se n√£o enviarmos body? 
               // N√£o, a API espera o config no body.
               
               // Ent√£o, hack r√°pido: Chamar saveDeviceConfig mas interceptar? N√£o.
               // Vamos replicar o fetch com sendToDevice: true.
               
               // (Repetindo extra√ß√£o r√°pida para garantir funcionamento)
               const fd = new FormData(form);
               const pFloat = (n) => { const v=fd.get(n); return v?parseFloat(v.replace(',','.')):undefined; };
               const pInt = (n) => { const v=fd.get(n); return v?parseInt(v):undefined; };
               const pBool = (n) => fd.get(n) === 'true';
               
               const config = {
                   stepperDirection: pBool('stepperDirection'), stepperSpeed: pInt('stepperSpeed'),
                   stepperStepsForward: pInt('stepperStepsForward'), stepperBackoffSteps: pInt('stepperBackoffSteps'),
                   servoTimeA: pInt('servoTimeA'), servoTimeB: pInt('servoTimeB'),
                   servoSpeed: pInt('servoSpeed'), servoSpeedA: pInt('servoSpeedA'), servoSpeedB: pInt('servoSpeedB'),
                   servoUseHome: pBool('servoUseHome'), scaleOffset: pFloat('scaleOffset'),
                   scaleFactor: pFloat('scaleFactor'), weightTolerance: pFloat('weightTolerance'),
                   scaleZeroTolerance: pFloat('scaleZeroTolerance'), defaultFeedAmountA: pFloat('defaultFeedAmountA'),
                   defaultFeedAmountB: pFloat('defaultFeedAmountB'), fallbackInterval: pInt('fallbackInterval'),
                   reservoirEmptyCm: pFloat('reservoirEmptyCm'), reservoirFullCm: pFloat('reservoirFullCm'),
                   debugEnabled: pBool('debugEnabled'), debugLevelSensor: pBool('debugLevelSensor'),
                   animalType: fd.get('animalType') || undefined, animalAName: fd.get('animalAName') || undefined,
                   animalBName: fd.get('animalBName') || undefined, apiNotificationUrl: fd.get('apiNotificationUrl') || undefined,
                   apiNotificationUseSSL: pBool('apiNotificationUseSSL')
               };
               const schedules = [];
               for(let i=0; i<10; i++) {
                   schedules.push({
                       hour: parseInt(fd.get(`schedule${i}_hour`))||0, minute: parseInt(fd.get(`schedule${i}_minute`))||0,
                       amountA: parseFloat(fd.get(`schedule${i}_amountA`).replace(',','.'))||0, amountB: parseFloat(fd.get(`schedule${i}_amountB`).replace(',','.'))||0,
                       enabled: fd.get(`schedule${i}_enabled`)==='true'
                   });
               }
               config.schedules = schedules;
               Object.keys(config).forEach(k => config[k]===undefined && delete config[k]);

               const res = await fetch('/admin/api/comedor/device/config', {
                   method: 'POST', headers: {'Content-Type': 'application/json'},
                   body: JSON.stringify({ ip: currentEditingDevice.ip, deviceId: currentEditingDevice.deviceId, config, sendToDevice: true })
               });
               const data = await res.json();
               if(data.success) {
                   showToast('Config enviada ao ESP32!', 'success');
               } else {
                   showToast('Erro ao enviar: ' + data.error, 'error');
               }
           } catch(e) { showToast('Erro ao enviar', 'error'); }
       }

       async function fetchDeviceConfigFromESP() {
           if(!currentEditingDevice) return;
           showToast('Buscando do ESP...', 'info');
           try {
               const q = `ip=${currentEditingDevice.ip}&deviceId=${currentEditingDevice.deviceId||''}`;
               const res = await fetch(`/admin/api/comedor/device/config/fetch?${q}`);
               const data = await res.json();
               if(data.success) {
                   showToast('Dados atualizados do ESP!', 'success');
                   // Recarrega o modal com os novos dados
                   openDeviceConfigModal(currentEditingDevice.ip, currentEditingDevice.deviceId);
               } else {
                   showToast('Falha ao buscar do ESP', 'error');
               }
           } catch(e) { showToast('Erro de conex√£o', 'error'); }
       }

       function closeComedorDeviceModal() {
           document.getElementById('comedorDeviceModal').style.display = 'none';
       }

       function closeTuyaDeviceModal() {
            document.getElementById('tuyaDeviceModal').style.display = 'none';
       }

       // --- LOAD ON START ---
       function loadComedorTab() {
           loadComedorToken();
           loadComedorDevices();
       }
    </script>
</body>
</html>